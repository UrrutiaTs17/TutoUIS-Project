<!-- Page Header -->
<div class="users-header">
  <div class="header-content">
    <div class="header-title-section">
      <div class="icon-wrapper">
        <i class="bi bi-people-fill"></i>
      </div>
      <div>
        <h2 class="page-title">Gestión de Usuarios</h2>
        <p class="page-subtitle">Administra los usuarios, roles y permisos del sistema</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-header-outline" (click)="loadUsers()" title="Recargar lista">
        <i class="bi bi-arrow-clockwise"></i>
        <span>Recargar</span>
      </button>
      <button class="btn-header" (click)="openCreateUserModal()">
        <i class="bi bi-person-plus-fill"></i>
        <span>Nuevo Usuario</span>
      </button>
    </div>
  </div>
</div>

<!-- Card de Usuarios -->
<div class="card">
  <div class="card-body">
    <!-- Barra de búsqueda y filtros -->
    <div class="search-filter-bar">
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input 
          type="text" 
          class="form-control" 
          placeholder="Buscar por nombre, código o correo..."
          [(ngModel)]="searchTerm"
          (input)="filterUsers()"
        />
      </div>
      <div class="filter-dropdown">
        <select 
          class="form-select"
          [(ngModel)]="filterRole"
          (change)="filterUsers()"
        >
          <option value="all">Todos los roles</option>
          <option *ngFor="let rol of roles" [value]="rol.idRol">{{ rol.nombre }}</option>
        </select>
      </div>
      <div class="filter-dropdown">
        <select 
          class="form-select"
          [(ngModel)]="filterStatus"
          (change)="filterUsers()"
        >
          <option value="all">Todos los estados</option>
          <option value="active">Activos</option>
          <option value="inactive">Inactivos</option>
          <option value="blocked">Bloqueados</option>
        </select>
      </div>
    </div>

    <!-- Loading spinner -->
    @if (loadingUsers) {
      <div class="loading-spinner">
        <div class="spinner-border text-success" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando usuarios...</p>
      </div>
    }

    <!-- Tabla de usuarios -->
    @if (!loadingUsers && usuariosFiltrados.length > 0) {
      <div class="users-table-container">
        <table class="users-table table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Código</th>
              <th>Correo</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Fecha Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (usuario of usuariosFiltrados; track usuario.id_usuario) {
              <tr>
                <td>
                  <div class="user-info">
                    <div class="user-avatar-small">
                      {{ usuario.nombre.charAt(0) + usuario.apellido.charAt(0) }}
                    </div>
                    <div class="user-details">
                      <h6>{{ getUserFullName(usuario) }}</h6>
                      <small>{{ usuario.telefono || 'Sin teléfono' }}</small>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="fw-bold">{{ usuario.codigo }}</span>
                </td>
                <td>{{ usuario.correo }}</td>
                <td>
                  <span class="badge" [ngClass]="getRoleBadgeClass(usuario.id_rol)">
                    {{ getRoleName(usuario.id_rol) }}
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(usuario)">
                    {{ getUserStatus(usuario) }}
                  </span>
                </td>
                <td>
                  <small>{{ usuario.fecha_creacion | date: 'dd/MM/yyyy HH:mm' }}</small>
                </td>
                <td>
                  <div class="action-buttons">
                    <!-- Botón Editar -->
                    <button 
                      class="btn btn-sm btn-outline-primary"
                      (click)="openEditUserModal(usuario)"
                      title="Editar usuario"
                    >
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    
                    <!-- Botón Bloquear/Desbloquear -->
                    <button 
                      class="btn btn-sm"
                      [ngClass]="usuario.bloqueado ? 'btn-outline-success' : 'btn-outline-warning'"
                      (click)="toggleBlockUser(usuario)"
                      [title]="usuario.bloqueado ? 'Desbloquear usuario' : 'Bloquear usuario'"
                    >
                      <i [class]="usuario.bloqueado ? 'bi bi-unlock-fill' : 'bi bi-lock-fill'"></i>
                    </button>
                    
                    <!-- Botón Eliminar -->
                    <button 
                      class="btn btn-sm btn-outline-danger" 
                      (click)="deleteUser(usuario)"
                      title="Eliminar usuario"
                    >
                      <i class="bi bi-trash3-fill"></i>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Información de resultados -->
      <div class="results-info">
        <small class="text-muted">
          Mostrando {{ usuariosFiltrados.length }} de {{ usuarios.length }} usuarios
        </small>
      </div>
    }

    <!-- Estado vacío con filtros -->
    @if (!loadingUsers && usuariosFiltrados.length === 0 && usuarios.length > 0) {
      <div class="empty-state">
        <i class="bi bi-search-heart"></i>
        <h5>No se encontraron usuarios</h5>
        <p>Intenta ajustar los filtros de búsqueda</p>
        <button class="btn btn-outline-secondary" (click)="searchTerm = ''; filterRole = 'all'; filterStatus = 'all'; filterUsers()">
          <i class="bi bi-x-circle-fill me-2"></i>Limpiar filtros
        </button>
      </div>
    }

    <!-- Estado vacío sin usuarios -->
    @if (!loadingUsers && usuarios.length === 0) {
      <div class="empty-state">
        <i class="bi bi-person-exclamation"></i>
        <h5>No hay usuarios registrados</h5>
        <p>Comienza agregando un nuevo usuario</p>
        <button class="btn btn-primary mt-3" (click)="openCreateUserModal()">
          <i class="bi bi-person-plus-fill me-2"></i>Agregar Usuario
        </button>
      </div>
    }
  </div>
</div>

<!-- Modal de Crear Usuario -->
<app-create-user-modal
  (userCreated)="onUserCreated($event)"
></app-create-user-modal>

<!-- Modal de Editar Usuario -->
<app-edit-user-modal
  (userUpdated)="onUserUpdated($event)"
></app-edit-user-modal>
