<div class="container py-4">

  <!-- Indicador de carga -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Cargando tutorías...</span>
    </div>
    <p class="mt-3 text-muted">Cargando tutorías disponibles...</p>
  </div>

  <!-- Mensaje de error (no bloqueante, se puede cerrar) -->
  <div *ngIf="error" class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
    <i class="bi bi-info-circle-fill me-2"></i>
    {{ error }}
    <button type="button" class="btn-close" (click)="error = ''" aria-label="Cerrar"></button>
  </div>

  <!-- Buscador y Calendario (se muestra incluso si hay error) -->
  <div *ngIf="!loading" class="card search-card mb-4">
  <div class="card-body position-relative">
      <h2>
        Buscar Materia
      </h2>

  <div class="position-relative w-100 mb-3">
  <!-- Ícono de lupa eliminado para evitar duplicado -->
  <div class="d-flex align-items-center position-relative flex-row w-100" style="gap:0.5rem;">
          <div style="position:relative; width:100%; display:flex; align-items:center;">
            <i class="bi bi-search" aria-hidden="true"></i>
            <input
              class="form-control"
              placeholder="Busca una materia por nombre, docente o código"
              [formControl]="searchControl"
              (keydown.enter)="selectFirst()"
              aria-label="Buscar materias"
              autocomplete="off"
              (focus)="showDropdown = true" />
            <button *ngIf="searchControl.value && searchControl.value.trim()" type="button"
              class="btn-limpiar position-absolute border-0"
              style="top:50%; right:8px; transform:translateY(-50%); z-index:2;"
              (click)="searchControl.setValue('')" aria-label="Limpiar búsqueda">
              <i class="bi bi-eraser-fill"></i>
              Limpiar
            </button>
          </div>
          <span *ngIf="!searchControl.value || !searchControl.value.trim()" class="d-flex align-items-center search-help-animated">
            <i class="bi bi-info-circle me-2"></i>
            Escribe para filtrar materias disponibles
          </span>
        </div>
        <ul *ngIf="showDropdown && searchControl.value && searchControl.value.trim()"
            class="list-group position-absolute w-100 mt-2 shadow rounded-3"
            role="listbox" style="z-index:10;">
          <li *ngFor="let c of (suggestions$ | async); let i = index; trackBy: trackMateria"
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            role="option" (click)="select(c)"
            [class.active]="i === activeIndex">
            <span>
              {{ c.nombre }}
              <small class="text-muted">• {{ c.docente }}</small>
            </span>
            <span class="badge bg-success-subtle text-success">{{ c.cupos }}</span>
          </li>
          <li *ngIf="showDropdown && searchControl.value && searchControl.value.trim() && !(activeIndex > -1) && (suggestions$ | async)?.length === 0"
              class="list-group-item text-muted text-center">
            <i class="bi bi-emoji-frown me-2"></i>
            No se encontraron materias con ese criterio
          </li>
        </ul>
        <ng-container *ngIf="searchControl.value && searchControl.value.trim()">
          <ng-container *ngIf="suggestions$ | async as results">
            <div *ngIf="results.length > 0" style="margin-top:2.5rem;" class="card calendar-card">
              <div class="card-header bg-light d-flex align-items-center gap-2">
                <i class="bi bi-calendar3" aria-hidden="true"></i>
                <h3 class="mb-0">Horario Disponible</h3>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive calendar-scroll">
                  <table class="table calendar-table align-middle" role="grid" aria-label="Horario semanal">
                    <caption class="visually-hidden">Calendario semanal de tutorías</caption>
                    <thead>
                      <tr>
                        <th class="time-col" scope="col">Hora</th>
                        <th scope="col" *ngFor="let d of dias; trackBy: trackDia">
                          {{ d }}
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let h of horas; trackBy: trackHora">
                        <th class="time-col" scope="row">
                          <span class="time-badge">
                            <i class="bi bi-clock me-1" aria-hidden="true"></i>
                            {{ h }}
                          </span>
                        </th>
                        <td *ngFor="let d of dias; trackBy: trackDia"
                            class="schedule-cell"
                            tabindex="0" role="button"
                            [attr.data-hora]="h" [attr.data-dia]="d"
                            (click)="selectCell(h,d)"
                            (keydown.enter)="selectCell(h,d)"
                            [class.is-selected]="isSelected(h,d)">
                          <!-- tarjeta si hay materia colocada en esa celda -->
                          <ng-container *ngIf="getMateriaFiltrada(h,d) as m; else emptyCell">
                            <article class="curso-card" [ngClass]="m.clase" [title]="m.tooltip || ''">
                              <h4 class="curso-title">{{ m.nombre }}</h4>
                              <p class="curso-meta">{{ m.detalle }}</p>
                              <div class="curso-badges">
                                <span class="badge-cap">Cupos: {{ m.cupos }}</span>
                              </div>
                            </article>
                          </ng-container>
                          <!-- celda vacía accesible -->
                          <ng-template #emptyCell>
                            <span class="visually-hidden">Sin asignación</span>
                          </ng-template>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Slots de 15 Minutos -->
<div *ngIf="showSlotModal" class="modal-overlay" (click)="closeSlotModal()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-clock me-2"></i>Selecciona tu Horario (15 minutos)
        </h5>
        <button type="button" class="btn-close" (click)="closeSlotModal()"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <div class="tutoria-info mb-4">
          <h6 class="text-success mb-2">
            <i class="bi bi-book me-2"></i>{{ selectedTutoria?.nombre || 'Tutoría' }}
          </h6>
          <p class="text-muted mb-1">
            <i class="bi bi-person me-2"></i>{{ selectedTutoria?.nombreTutor || 'Tutor' }}
          </p>
          <p class="text-muted mb-0">
            <i class="bi bi-calendar-week me-2"></i>{{ selectedDisponibilidad?.diaSemana }}
            <span class="ms-2">
              <i class="bi bi-clock me-1"></i>{{ selectedDisponibilidad?.horaInicio }} - {{ selectedDisponibilidad?.horaFin }}
            </span>
          </p>
        </div>

        <!-- Slots disponibles -->
        <div class="slots-grid">
          <button
            *ngFor="let slot of availableSlots"
            type="button"
            class="slot-button"
            [class.selected]="selectedSlot?.inicio === slot.inicio"
            (click)="selectSlot(slot)">
            <i class="bi bi-clock-fill me-2"></i>{{ slot.display }}
          </button>
        </div>

        <!-- Campo de observaciones -->
        <div class="mt-4">
          <label for="observaciones" class="form-label">
            <i class="bi bi-chat-left-text me-2"></i>Observaciones (opcional)
          </label>
          <textarea
            id="observaciones"
            class="form-control"
            rows="3"
            [(ngModel)]="observaciones"
            [disabled]="creandoReserva"
            placeholder="Ej: Necesito ayuda con límites y derivadas"></textarea>
        </div>

        <!-- Mensaje de error -->
        <div *ngIf="errorMessage" class="alert alert-danger mt-3 mb-0">
          <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMessage }}
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          (click)="closeSlotModal()"
          [disabled]="creandoReserva">
          <i class="bi bi-x-circle me-2"></i>Cancelar
        </button>
        <button
          type="button"
          class="btn btn-success"
          (click)="confirmarReserva()"
          [disabled]="!selectedSlot || creandoReserva">
          <span *ngIf="creandoReserva" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!creandoReserva" class="bi bi-check-circle me-2"></i>
          {{ creandoReserva ? 'Creando...' : 'Confirmar Reserva' }}
        </button>
      </div>
    </div>
  </div>
</div>
