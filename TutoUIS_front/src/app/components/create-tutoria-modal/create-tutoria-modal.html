<!-- Modal para crear tutoría -->
<div 
  #createTutoriaModal 
  class="modal fade" 
  id="createTutoriaModal" 
  tabindex="-1" 
  aria-labelledby="createTutoriaModalLabel" 
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Header del Modal -->
      <div class="modal-header bg-primary text-white">
        <h1 class="modal-title fs-5" id="createTutoriaModalLabel">
          <i class="bi bi-plus-circle me-2"></i> Crear Nueva Tutoría
        </h1>
        <button 
          type="button" 
          class="btn-close btn-close-white" 
          (click)="close()" 
          aria-label="Cerrar">
        </button>
      </div>

      <!-- Body del Modal -->
      <div class="modal-body">
        <!-- Mensajes de estado -->
        <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-circle me-2"></i>
          {{ errorMessage }}
          <button 
            type="button" 
            class="btn-close" 
            (click)="errorMessage = ''" 
            aria-label="Cerrar">
          </button>
          <div class="mt-2">
            <button 
              type="button" 
              class="btn btn-sm btn-outline-danger"
              (click)="recargarDatos()">
              <i class="bi bi-arrow-clockwise me-1"></i> Reintentar
            </button>
          </div>
        </div>

        <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle me-2"></i>
          {{ successMessage }}
        </div>

        <!-- Información de carga -->
        <div *ngIf="!loading && !errorMessage && tutores.length > 0 && carreras.length > 0" class="alert alert-info mb-3">
          <i class="bi bi-info-circle me-2"></i>
          <strong>✓ Datos cargados exitosamente:</strong> {{ tutores.length }} {{ tutores.length === 1 ? 'tutor' : 'tutores' }} y {{ carreras.length }} {{ carreras.length === 1 ? 'carrera' : 'carreras' }} disponibles
        </div>
        
        <!-- Advertencia de datos faltantes -->
        <div *ngIf="!loading && !errorMessage && (tutores.length === 0 || carreras.length === 0)" class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Datos incompletos:</strong>
          <ul class="mb-0 mt-2">
            <li *ngIf="tutores.length === 0">No hay tutores disponibles (usuarios con rol_id = 2)</li>
            <li *ngIf="carreras.length === 0">No hay carreras registradas en el sistema</li>
          </ul>
          <div class="mt-2">
            <small class="text-muted">
              <i class="bi bi-lightbulb me-1"></i>
              Por favor, asegúrate de tener al menos un tutor y una carrera registrados antes de crear una tutoría.
            </small>
          </div>
        </div>

        <!-- Spinner de carga -->
        <div *ngIf="loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2 text-muted">Cargando datos...</p>
          <small class="text-muted">Conectando con el servidor...</small>
        </div>

        <!-- Formulario -->
        <form *ngIf="!loading" (ngSubmit)="submitForm()" #tutoriaForm="ngForm">
          <!-- Fila 1: Tutor y Carrera (Carrera automática) -->
          <div class="row mb-3">
            <!-- Seleccionar Tutor -->
            <div class="col-md-6">
              <label for="tutorSelect" class="form-label">
                <span class="text-danger">*</span> Tutor
              </label>
              <select
                id="tutorSelect"
                class="form-select"
                [(ngModel)]="form.idTutor"
                (change)="onTutorChange()"
                name="idTutor"
                [disabled]="submitting || tutores.length === 0"
                required>
                <option value="">Selecciona un tutor</option>
                <option *ngIf="tutores.length === 0" disabled>
                  No hay tutores disponibles
                </option>
                <option *ngFor="let tutor of tutores" [value]="tutor.id_usuario">
                  {{ tutor.nombre }} {{ tutor.apellido }}
                </option>
              </select>
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Selecciona el tutor responsable
              </small>
            </div>

            <!-- Carrera asociada (solo lectura) -->
            <div class="col-md-6">
              <label class="form-label"><span class="text-danger">*</span> Carrera Asociada</label>
              <input
                type="text"
                class="form-control"
                [value]="carreraSeleccionadaNombre || '— Selecciona un tutor —'"
                readonly
              />
              <small class="text-muted" *ngIf="!carreraSeleccionadaNombre">
                <i class="bi bi-info-circle"></i> La carrera se llenará automáticamente
              </small>
              <small class="text-muted" *ngIf="carreraSeleccionadaNombre">
                <i class="bi bi-check-circle text-success"></i> Carrera asignada automáticamente
              </small>
            </div>
          </div>

          <!-- Fila 2: Asignatura y Modalidad -->
          <div class="row mb-3">
            <!-- Asignatura -->
            <div class="col-md-6">
              <label class="form-label"><span class="text-danger">*</span> Asignatura</label>
              <select
                class="form-select"
                [(ngModel)]="form.idAsignatura"
                name="idAsignatura"
                [disabled]="submitting || asignaturasFiltradas.length === 0"
                required>
                <option value="">Selecciona una asignatura</option>
                <option *ngIf="asignaturasFiltradas.length === 0" disabled>No hay asignaturas disponibles</option>
                <option *ngFor="let asignatura of asignaturasFiltradas" [value]="asignatura.idAsignatura">
                  {{ asignatura.nombre }}
                </option>
              </select>
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Lista filtrada por carrera (si aplica)
              </small>
            </div>

            <!-- Modalidad -->
            <div class="col-md-6">
              <label class="form-label"><span class="text-danger">*</span> Modalidad</label>
              <select
                class="form-select"
                [(ngModel)]="form.modalidad"
                name="modalidad"
                [disabled]="submitting"
                required>
                <option value="">Selecciona modalidad</option>
                <option value="Presencial">Presencial</option>
                <option value="Virtual">Virtual</option>
                <option value="Híbrida">Híbrida</option>
              </select>
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Formato en que se ofrece la tutoría
              </small>
            </div>
          </div>

          <!-- Fila 3: Nombre de Tutoría -->
          <div class="mb-3">
            <label for="nombreInput" class="form-label">
              <span class="text-danger">*</span> Nombre de la Tutoría
            </label>
            <input
              type="text"
              id="nombreInput"
              class="form-control"
              [(ngModel)]="form.nombre"
              name="nombre"
              placeholder="ej: Cálculo Diferencial"
              [disabled]="submitting"
              maxlength="100"
              required>
            <small class="text-muted">
              <i class="bi bi-info-circle"></i> Máximo 100 caracteres
            </small>
          </div>

          <!-- Fila 4: Descripción -->
          <div class="mb-3">
            <label for="descripcionInput" class="form-label">Descripción</label>
            <textarea
              id="descripcionInput"
              class="form-control"
              [(ngModel)]="form.descripcion"
              name="descripcion"
              placeholder="Descripción de la tutoría (opcional)"
              rows="3"
              [disabled]="submitting"
              maxlength="500">
            </textarea>
            <small class="text-muted">
              <i class="bi bi-info-circle"></i> Máximo 500 caracteres
            </small>
          </div>

          <!-- Fila 5: Capacidad y Ubicación -->
          <div class="row mb-3">
            <!-- Capacidad Máxima -->
            <div class="col-md-6">
              <label for="capacidadInput" class="form-label">
                <span class="text-danger">*</span> Capacidad Máxima
              </label>
              <input
                type="number"
                id="capacidadInput"
                class="form-control"
                [(ngModel)]="form.capacidadMaxima"
                name="capacidadMaxima"
                placeholder="30"
                [disabled]="submitting"
                min="1"
                max="100"
                required>
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Entre 1 y 100 estudiantes
              </small>
            </div>

            <!-- Ubicación -->
            <div class="col-md-6">
              <label for="ubicacionInput" class="form-label">Ubicación</label>
              <input
                type="text"
                id="ubicacionInput"
                class="form-control"
                [(ngModel)]="form.ubicacion"
                name="ubicacion"
                placeholder="ej: Sala 201"
                [disabled]="submitting"
                maxlength="100">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Ubicación física (opcional)
              </small>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer del Modal -->
      <div class="modal-footer bg-light">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="close()"
          [disabled]="submitting">
          <i class="bi bi-x-circle me-2"></i> Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="submitForm()"
          [disabled]="submitting || loading || tutores.length === 0 || carreras.length === 0"
          [title]="getBotonCrearTooltip()">
          <span *ngIf="!submitting">
            <i class="bi bi-check-circle me-2"></i> Crear Tutoría
          </span>
          <span *ngIf="submitting">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Creando...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
