<!-- Modal para crear tutoría -->
<div 
  #createTutoriaModal 
  class="modal fade" 
  id="createTutoriaModal" 
  tabindex="-1" 
  aria-labelledby="createTutoriaModalLabel" 
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <!-- Header del Modal -->
      <div class="modal-header text-white" [ngClass]="isEditMode ? 'bg-warning' : 'bg-success'">
        <h1 class="modal-title fs-5" id="createTutoriaModalLabel">
          <i class="bi me-2" [ngClass]="isEditMode ? 'bi-pencil-square' : 'bi-plus-circle'"></i> 
          {{ isEditMode ? 'Editar Tutoría' : 'Crear Nueva Tutoría' }}
        </h1>
        <button 
          type="button" 
          class="btn-close btn-close-white" 
          (click)="close()" 
          aria-label="Cerrar">
        </button>
      </div>

      <!-- Body del Modal -->
      <div class="modal-body">
        <!-- Mensajes de estado -->
        <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-circle me-2"></i>
          {{ errorMessage }}
          <button 
            type="button" 
            class="btn-close" 
            (click)="errorMessage = ''" 
            aria-label="Cerrar">
          </button>
          <div class="mt-2">
            <button 
              type="button" 
              class="btn btn-sm btn-outline-danger"
              (click)="recargarDatos()">
              <i class="bi bi-arrow-clockwise me-1"></i> Reintentar
            </button>
          </div>
        </div>

        <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle me-2"></i>
          {{ successMessage }}
        </div>

        <!-- Información de carga -->
        <div *ngIf="!loading && !errorMessage && tutores.length > 0 && carreras.length > 0" class="alert alert-info mb-3">
          <i class="bi bi-info-circle me-2"></i>
          <strong>✓ Datos cargados exitosamente:</strong> {{ tutores.length }} {{ tutores.length === 1 ? 'tutor' : 'tutores' }} y {{ carreras.length }} {{ carreras.length === 1 ? 'carrera' : 'carreras' }} disponibles
        </div>
        
        <!-- Advertencia de datos faltantes (solo después de intentar cargar) -->
        <div *ngIf="datosIntentadosCargar && !loading && !errorMessage && (tutores.length === 0 || carreras.length === 0)" class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Datos incompletos:</strong>
          <ul class="mb-0 mt-2">
            <li *ngIf="tutores.length === 0">No hay tutores disponibles (usuarios con rol_id = 2)</li>
            <li *ngIf="carreras.length === 0">No hay carreras registradas en el sistema</li>
          </ul>
          <div class="mt-2">
            <small class="text-muted">
              <i class="bi bi-lightbulb me-1"></i>
              Por favor, asegúrate de tener al menos un tutor y una carrera registrados antes de crear una tutoría.
            </small>
          </div>
        </div>

        <!-- Spinner de carga -->
        <div *ngIf="loading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2 text-muted">Cargando datos...</p>
          <small class="text-muted">Conectando con el servidor...</small>
        </div>

        <!-- Formulario -->
        <form *ngIf="!loading" (ngSubmit)="submitForm()" #tutoriaForm="ngForm">
          <!-- Fila 1: Tutor y Carrera (Carrera automática) -->
          <div class="row mb-3">
            <!-- Seleccionar Tutor -->
            <div class="col-md-6">
              <label for="tutorSelect" class="form-label">
                <span class="text-danger">*</span> Tutor
              </label>
              <select
                id="tutorSelect"
                class="form-select"
                [(ngModel)]="form.idTutor"
                (change)="onTutorChange()"
                name="idTutor"
                [disabled]="submitting || tutores.length === 0 || isEditMode"
                required>
                <option value="">Selecciona un tutor</option>
                <option *ngIf="tutores.length === 0" disabled>
                  No hay tutores disponibles
                </option>
                <option *ngFor="let tutor of tutores" [value]="tutor.id_usuario">
                  {{ tutor.nombre }} {{ tutor.apellido }}
                </option>
              </select>
              <small class="text-muted" *ngIf="!isEditMode">
                <i class="bi bi-info-circle"></i> Selecciona el tutor responsable
              </small>
              <small class="text-muted" *ngIf="isEditMode">
                <i class="bi bi-lock-fill"></i> No editable
              </small>
            </div>

            <!-- Carrera asociada (solo lectura) -->
            <div class="col-md-6">
              <label class="form-label"><span class="text-danger">*</span> Carrera Asociada</label>
              <input
                type="text"
                class="form-control"
                [value]="carreraSeleccionadaNombre || '— Selecciona un tutor —'"
                readonly
              />
              <small class="text-muted" *ngIf="!carreraSeleccionadaNombre">
                <i class="bi bi-info-circle"></i> La carrera se llenará automáticamente
              </small>
              <small class="text-muted" *ngIf="carreraSeleccionadaNombre">
                <i class="bi bi-check-circle text-success"></i> Carrera asignada automáticamente
              </small>
            </div>
          </div>

          <!-- Fila 2: Asignatura y Modalidad -->
          <div class="row mb-3">
            <!-- Asignatura -->
            <div class="col-md-6">
              <label class="form-label"><span class="text-danger">*</span> Asignatura</label>
              <select
                class="form-select"
                [(ngModel)]="form.idAsignatura"
                name="idAsignatura"
                [disabled]="submitting || asignaturasFiltradas.length === 0 || isEditMode"
                required>
                <option value="">Selecciona una asignatura</option>
                <option *ngIf="asignaturasFiltradas.length === 0" disabled>No hay asignaturas disponibles</option>
                <option *ngFor="let asignatura of asignaturasFiltradas" [value]="asignatura.idAsignatura">
                  {{ asignatura.nombre }}
                </option>
              </select>
              <small class="text-muted" *ngIf="!isEditMode">
                <i class="bi bi-info-circle"></i> Lista filtrada por carrera (si aplica)
              </small>
              <small class="text-muted" *ngIf="isEditMode">
                <i class="bi bi-lock-fill"></i> No editable
              </small>
            </div>

            <!-- Modalidad -->
            <div class="col-md-6">
              <label class="form-label"><span class="text-danger">*</span> Modalidad</label>
              <select
                class="form-select"
                [(ngModel)]="form.modalidad"
                name="modalidad"
                [disabled]="submitting"
                required>
                <option value="">Selecciona modalidad</option>
                <option value="Presencial">Presencial</option>
                <option value="Virtual">Virtual</option>
                <option value="Híbrida">Híbrida</option>
              </select>
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Formato en que se ofrece la tutoría
              </small>
            </div>
          </div>

          <!-- Fila 3: Descripción -->
          <div class="mb-3">
            <label for="descripcionInput" class="form-label">Descripción</label>
            <textarea
              id="descripcionInput"
              class="form-control"
              [(ngModel)]="form.descripcion"
              name="descripcion"
              placeholder="Descripción de la tutoría (opcional)"
              rows="3"
              [disabled]="submitting"
              maxlength="500">
            </textarea>
            <small class="text-muted">
              <i class="bi bi-info-circle"></i> Máximo 500 caracteres
            </small>
          </div>

          <!-- Fila 4: Capacidad y Ubicación -->
          <div class="row mb-3">
            <!-- Capacidad Máxima -->
            <div class="col-md-6">
              <label for="capacidadInput" class="form-label">
                <span class="text-danger">*</span> Capacidad Máxima
              </label>
              <input
                type="number"
                id="capacidadInput"
                class="form-control"
                [(ngModel)]="form.capacidadMaxima"
                name="capacidadMaxima"
                placeholder="30"
                [disabled]="submitting"
                min="1"
                max="100"
                required>
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Entre 1 y 100 estudiantes
              </small>
            </div>

            <!-- Ubicación -->
            <div class="col-md-6">
              <label for="ubicacionInput" class="form-label">Ubicación</label>
              <input
                type="text"
                id="ubicacionInput"
                class="form-control"
                [(ngModel)]="form.ubicacion"
                name="ubicacion"
                placeholder="ej: Sala 201"
                [disabled]="submitting"
                maxlength="100">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Ubicación física (opcional)
              </small>
            </div>
          </div>

          <!-- Sección de Disponibilidades -->
          <div class="disponibilidades-section mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">
                <i class="bi bi-calendar-week me-2"></i>Disponibilidades
              </h5>
              <button
                type="button"
                class="btn btn-sm btn-success"
                (click)="agregarDisponibilidad()"
                [disabled]="submitting">
                <i class="bi bi-plus-circle me-1"></i> Agregar Horario
              </button>
            </div>

            <small class="text-muted d-block mb-3">
              <i class="bi bi-info-circle"></i> Agrega al menos una disponibilidad horaria para la tutoría
            </small>

            <!-- Lista de disponibilidades -->
            <div *ngIf="disponibilidades.length === 0" class="alert alert-info">
              <i class="bi bi-calendar-x me-2"></i> 
              No hay disponibilidades agregadas. Haz clic en "Agregar Horario" para crear una.
            </div>

            <div class="disponibilidad-item" *ngFor="let disp of disponibilidades; let i = index">
              <div class="row g-3">
                <!-- Día de la semana -->
                <div class="col-md-3">
                  <label class="form-label">
                    <span class="text-danger">*</span> Día
                  </label>
                  <select
                    class="form-select form-select-sm"
                    [(ngModel)]="disp.diaSemana"
                    [name]="'diaSemana' + i"
                    [disabled]="submitting"
                    required>
                    <option value="">Selecciona</option>
                    <option value="Lunes">Lunes</option>
                    <option value="Martes">Martes</option>
                    <option value="Miércoles">Miércoles</option>
                    <option value="Jueves">Jueves</option>
                    <option value="Viernes">Viernes</option>
                    <option value="Sábado">Sábado</option>
                    <option value="Domingo">Domingo</option>
                  </select>
                </div>

                <!-- Fecha -->
                <div class="col-md-3">
                  <label class="form-label">
                    <span class="text-danger">*</span> Fecha
                  </label>
                  <input
                    type="date"
                    class="form-control form-control-sm"
                    [(ngModel)]="disp.fecha"
                    [name]="'fecha' + i"
                    [disabled]="submitting"
                    required>
                </div>

                <!-- Hora Inicio -->
                <div class="col-md-2">
                  <label class="form-label">
                    <span class="text-danger">*</span> Hora Inicio
                  </label>
                  <input
                    type="time"
                    class="form-control form-control-sm"
                    [(ngModel)]="disp.horaInicio"
                    [name]="'horaInicio' + i"
                    [disabled]="submitting"
                    required>
                </div>

                <!-- Hora Fin -->
                <div class="col-md-2">
                  <label class="form-label">
                    <span class="text-danger">*</span> Hora Fin
                  </label>
                  <input
                    type="time"
                    class="form-control form-control-sm"
                    [(ngModel)]="disp.horaFin"
                    [name]="'horaFin' + i"
                    [disabled]="submitting"
                    required>
                </div>

                <!-- Botón Eliminar -->
                <div class="col-md-2 d-flex align-items-end">
                  <button
                    type="button"
                    class="btn btn-danger btn-sm w-100"
                    (click)="eliminarDisponibilidad(i)"
                    [disabled]="submitting"
                    title="Eliminar disponibilidad">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer del Modal -->
      <div class="modal-footer bg-light">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="close()"
          [disabled]="submitting">
          <i class="bi bi-x-circle me-2"></i> Cancelar
        </button>
        <button
          type="button"
          [ngClass]="isEditMode ? 'btn btn-warning' : 'btn btn-success'"
          (click)="submitForm()"
          [disabled]="submitting || loading || tutores.length === 0 || carreras.length === 0">
          <span *ngIf="!submitting">
            <i class="bi me-2" [ngClass]="isEditMode ? 'bi-pencil-square' : 'bi-check-circle'"></i> 
            {{ isEditMode ? 'Actualizar Tutoría' : 'Crear Tutoría' }}
          </span>
          <span *ngIf="submitting">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {{ isEditMode ? 'Actualizando...' : 'Creando...' }}
          </span>
        </button>
      </div>
    </div>
  </div>
</div>
